<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <link rel="stylesheet" href="/estaticos/mini.css">
</head>
<body>
<div id="wrapper"  class="col-sm-12 col-md-8 col-lg-6 col-md-offset-2  col-lg-offset-3">  
<header class="sticky">


<a href="https://celticman.github.io/"><h1 class="title">Celticman - notas personales</h1></a>

</header>


<h1 id="nas-con-linux-ubuntu">NAS con Linux (Ubuntu)</h1>
<h2 id="paquetes-necesarios">Paquetes necesarios</h2>
<p>Usaremos las siguientes utilidades:</p>
<ul>
<li>fdisk: (particionado)</li>
<li>badblocks: contenido en e2fsprogs (comprobación de escritura)</li>
<li>smartctl: contenido en smartmontools (Lectura estadísticas SMART)</li>
<li>lsblk: contenido en util-linux</li>
<li>utilidades ZFS: zfsutils-linux</li>
<li>cryptsetup: PAra usar particiones LUKS</li>
</ul>
<p>En Ubuntu se instalarían con:</p>
<pre><code>apt install fdisk e2fsprogs smartmontools util-linux zfsutils-linux cryptsetup-bin</code></pre>
<h2 id="comprobar-los-discos-duros-a-utilizar">Comprobar los discos duros a utilizar</h2>
<ol type="1">
<li><p>Comprobar que disco duro se quiere probar</p>
<p>lsblk -o NAME,MAJ:MIN,RM,SIZE,RO,TYPE,MOUNTPOINT,MODEL,SERIAL</p></li>
<li><p>Leer los datos SMART antes de ejecutar badblocks:</p>
<p>2.1. Imprime los test disponibles en el disco&gt;</p>
<pre><code> sudo smartctl -c /dev/sdX</code></pre>
<p>2.2. Imprime la información del disco:</p>
<pre><code> sudo smartctl -i /dev/sdX &gt; sdX_smart_informacion.txt</code></pre>
<p>2.3. Ejecutamos un test corto ó el largo:</p>
<pre><code> sudo smartctl -t short -C /dev/sdX

 sudo smartctl -t long -C /dev/sdX</code></pre>
<p>2.4. Visualizamos los resultados del test anterior:</p>
<pre><code> sudo smartctl -a /dev/sdX &gt; sdX_smart_inicial.txt</code></pre></li>
<li><p>Extraer los datos de tamaño de bloque del disco:</p>
<p>sudo -n blockdev –getbsz /dev/sdX</p></li>
<li><p>Ejecutar el programa badblocks con lectura y escritura</p>
<p>** Atención los siguientes test son destructivos **</p>
<p>4.1. Ejecutar un test completo (con varios tramas de datos):</p>
<pre><code> sudo badblocks -wsv /dev/sdx</code></pre>
<p>4.2. Ejecutar un test rápido (con una sola trama de datos):</p>
<pre><code> sudo badblocks -wsv -t 0xAA /dev/sdx</code></pre></li>
<li><p>Comprobar el efecto de la escritura y lectura de todos los bloques:</p>
<p>5.1. Volver a ejecutar el test SMART (corto o largo):</p>
<pre><code> sudo smartctl -t short -C /dev/sdX

 sudo smartctl -t long -C /dev/sdX</code></pre>
<p>5.2. Generar los resultados:</p>
<pre><code> sudo smartctl -a /dev/sdX &gt; sdX_smart_final.txt</code></pre></li>
<li><p>Comparar los dados iniciales (sdX_smart_inicial.txt) y finales (sdX_smart_final.txt):</p>
<p>Según del artículo: https://www.backblaze.com/blog/hard-drive-smart-stats/</p>
<p>Ejecutar el siguiente comando para comparar los dos resultados:</p>
<pre><code> cat sdX_smart*.txt | grep &#39;Reallocated\|Reported\|Command_Ti\|Current\|Offline_Un&#39;</code></pre>
<p>Por orden de importantancia:</p>
<pre><code> - Reallocated Sectors Count
 - Reported Uncorrectable Errors
 - Command Timeout
 - Current Pending Sector Count
 - Uncorrectable Sector Count</code></pre>
<p>Según el disco hay fallo ó no ejecutando:</p>
<pre><code> smartctl -H /dev/sdX</code></pre></li>
</ol>
<h2 id="creación-mirror-de-3-discos-btrfs-raid-1c3-con-cifrado-luks">Creación mirror de 3 discos BTRFS (Raid 1C3) con cifrado luks</h2>
<ol type="1">
<li><p>Crear las particiones en los discos:</p>
<p>fdisk /dev/sdX</p>
<pre><code> Comando1:   n (nueva particion)
 Comando2:   p (partición primaria)
 Comando3:   (valor predeterminado)
 Comando4:   (valor predeterminado)
 Comando5:   w   (escribir la nueva partición y salir)</code></pre></li>
<li><p>Crear fichero con clave cifrado</p>
<p>sudo touch /etc/btrfs_clave_cifrado sudo chmod 600 /etc/btrfs_clave_cifrado</p></li>
<li><p>Escribir la clave en el fichero</p>
<p>sudo vim /etc/btrfs_clave_cifrado</p></li>
<li><p>Cifrado de las particiones a utilizar, para todas las particiones creadas (p.ej.: /dev/sdb1 /dev/sdc1 /dev/sdd1).</p>
<p>cryptsetup luksFormat –type luks2 /dev/sdX1 /etc/btrfs_clave_cifrado</p></li>
<li><p>Extraer los UUID de las particiones cifradas con LUKS:</p>
<p>sudo cryptsetup luksDump /dev/sdX | grep UUID</p></li>
</ol>
<h2 id="creación-mirror-de-3-discos-con-zfs-con-cifrado-nativo">Creación mirror de 3 discos con ZFS con cifrado nativo</h2>
<p>Basado en (https://bhoey.com/blog/3-way-disk-mirrors-with-zfsonlinux/) y (https://ubuntu.com/tutorials/setup-zfs-storage-pool#1-overview).</p>
<ol type="1">
<li><p>Verificar los discos sobre los que se quiere crear la partición</p>
<ul>
<li><p>Listado del disco:</p>
<p>lsblk -o NAME,MAJ:MIN,RM,SIZE,RO,TYPE,MOUNTPOINTS,UUID,PARTUUID</p></li>
<li><p>Listado particiones:</p>
<p>sudo fdisk -l</p></li>
</ul></li>
<li><p>Creación de las particiones en los discos a usar:</p>
<ul>
<li><p>Se usaran /dev/sdb /deb/sdc /deb/sdd</p></li>
<li><p>Crear agrupacion de ZFS (Pool):</p>
<p>sudo zpool create -m /srv/espejo espejo mirror /dev/sdb /dev/sdc /dev/sdd</p></li>
<li><p>Habilitar el cifrado en la agrupación de ZFS (Pool):</p>
<p>sudo zpool set feature@encryption=enabled espejo</p></li>
<li><p>Activar el cifrado del conjunto de datos:</p>
<p>zfs create -o encryption=on -o keylocation=prompt -o keyformat=passphrase espejo/compartir</p>
<p>zfs create -o encryption=on -o keylocation=file:///etc/zfs_clave_cifrado -o keyformat=passphrase espejo/compartir</p></li>
</ul>
<p>El disco está montado en /srv/espejo</p></li>
<li><p>Comprobación estado online</p>
<p>sudo zpool status</p></li>
<li><p>Ejecutar una verificación del conjunto ZFS (Pool):</p>
<p>sud zpool scrub espejo</p></li>
</ol>


<footer>
Estilo: <a href="https://minicss.us">Mini.css</a>
Generador: <a href="https://pandoc.org/">pandoc 2.9.2.1</a>
Fecha: 2023-02-21
Alojamiento: <a href="https://github.com/celticman/celticman.github.io"><img src="/estaticos/gitHubmark32px.png"></a>
</footer>
</div>
</body>
</html>
